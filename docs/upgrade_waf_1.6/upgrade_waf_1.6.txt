Upgrade to waf 1.6 (draft)
=========================
:author: Thomas Nagy
:quotes.++:

[preface]
== Introduction

////
a2x -L -a toc --icons-dir=.   -v   --icons -d book -f pdf upgrade_waf_1.6.txt
////

Copyright (C) 2010 Thomas Nagy

Copies of this book may be redistributed, verbatim, and for non-commercial
purposes. The license for this book is
 http://creativecommons.org/licenses/by-nc-nd/3.0/[by-nc-nd license].

=== Waf 1.5 limitations

The waf build system was first created to provide an alternative for the autotool-based build systems based on a single programming language. To ease the development, a few assumptions were made, and over the time it became clear that they had become a limitation for specific corner cases, among others:

- sometimes, some files are generated in the source directory and are kept in the source control system
- there may be more than one kind of build command
- some configuration apis may be useful in the build section
- it may be interesting to use waf as a library from another system
- some apis were private (node objects)

=== Goals of Waf 1.6

The main goals of waf 1.6 are:

1 to remove most assumptions/restrictions present in waf 1.5 (nodes, build directory, reduce the coupling between the modules)
2 to optimize the code base (execution time, source code size, compatibility with different python versions)
3 to improve the apis and the user experience (make the apis more intuitive, expose more classes and functions, improve the error handling)

=== Purpose of this document

The apis had to be changed to make the changes described in the previous section, the apis (modules, classes. functions).
This document describes the main changes compared to the previous version, waf 1.5.
The waf book for waf 1.6 should be the reference for new users and for projects upgrading from previous waf versions such as waf 1.4.






== Changes in the user scripts

=== The command 'options'

The method set_options has been renamed to 'options':

[source,python]
---------------
top = '.'
out = 'build'

def options(opt):
	pass

def configure(ctx):
	pass
---------------

=== The method 'recurse'

The context class for all commands has a unique method named 'recurse'. The methods 'add_subdirs', 'sub_config' and 'sub_options' disappear:

[source,python]
---------------
def options(opt):
    #ctx.sub_options('src') # old
	ctx.recurse('src')

def configure(ctx):
	#ctx.sub_config('src') # old
	ctx.recurse('src')

def build(ctx):
	#ctx.add_subdirs('src') # old
	ctx.recurse('src')
---------------

=== Tool declaration

For consistency with the user scripts, the method 'detect' in waf tools has been renamed to 'configure'. The method 'set_options' is now called 'options' and is consistent with waf scripts.

=== Task generator declaration

The build context method 'new_task_gen' disappears, and is replaced by '__call__'. The task generator subclasses have been removed completely, so only keyword arguments are accepted. For example:

[source,python]
---------------
top = '.'
out = 'build'

def configure(ctx):
	pass

def build(bld):
	# bld.new_task_gen('cc', 'cprogram', source='main.c', target='app') # old
	bld(features='cc cprogram', source='main.c', target='app')
---------------



== Node classes

=== Targets in the source directory or in any location

The waf commands may now use Node objects in the source attribute. As a consequence, the build may update files that are to be kept versioned under the source directory.
In this case, the task signature may not be used as node signature (source files signatures are computed from a hash of the file). Here is an example:

[source,python]
---------------
top = '.'
out = 'build'

def configure(ctx):
	pass

def build(ctx):
	# create the node next to the current wscript file - no build directory
	node = bld.path.make_node('foo.txt')
	bld(rule='touch ${TARGET}', always=True, update_outputs=True, target=node)
---------------

For nodes present out of the build directory, the node signature must be set to the file hash immediately after the file is created or modified (not the task signature set by default):

[source,python]
---------------
import Task
class cls(Task.Task):
	run_str = '${CP} ${SRC} ${TGT}'
cls = Task.update_outputs(cls)
---------------




== Internal apis

=== Python 3 syntax

Python 3 is now the default syntax. Waf now runs unmodified for 2.6, 2.7, 3.0 and 3.1. Upon execution, a detection is performed and the code
is then converted for python 2.3, 2.4 and 2.5 if necessary.






== New commands

=== waf list

A new command named 'list' is used to list the valid targets (task generators) for "waf build --targets=x"

[source,shishell]
---------------
$ waf list
foo.exe
my_shared_lib
my_static_lib
test_shared_link
test_static_link
'list' finished successfully (0.029s)

$ waf clean --targets=foo.exe
Waf: Entering directory `/disk/comp/waf-1.6/demos/c/build'
[1/2] cc: program/main.c -> build/program/main.c.0.o
[2/2] cprogram: build/program/main.c.0.o -> build/foo.exe
Waf: Leaving directory `/disk/comp/waf-1.6/demos/c/build'
'build' finished successfully (0.154s)
---------------

=== waf step

The new command 'step' is used to execute specific tasks and to return the exit status or any error message. It is particularly useful for debugging:

[source,shishell]
---------------
waf clean step --file=test_shlib.c
'clean' finished successfully (0.017s)
Waf: Entering directory `/disk/comp/waf-1.6/demos/c/build'
cc: shlib/test_shlib.c -> build/shlib/test_shlib.c.1.o
 -> 0
cshlib: build/shlib/test_shlib.c.1.o -> build/shlib/libmy_shared_lib.so
 -> 0
Waf: Leaving directory `/disk/comp/waf-1.6/demos/c/build'
'step' finished successfully (0.146s)
---------------

To restrict the tasks to execute, just prefix the names by 'in:' or 'out:':

[source,shishell]
---------------
waf step --file=out:build/shlib/test_shlib.c.1.o
Waf: Entering directory `/disk/comp/waf-1.6/demos/c/build'
cc: shlib/test_shlib.c -> build/shlib/test_shlib.c.1.o
 -> 0
Waf: Leaving directory `/disk/comp/waf-1.6/demos/c/build'
'step' finished successfully (0.091s)
---------------

* Environment -> ConfigSet
* only lists are allowed in ConfigSet
* Utils.load_tool -> Context.load_tool
* only the build-related commands require a configured project
* new variant system + build context commands
* removed the pseudo glob in installation methods
* eliminate find_sources_in_dirs
* node.__class__.bld â†’ node.ctx
* network updates for waf tools
* accept node objects in the source and includes attributes
* remove task_gen.allnodes: modify self.source directly
* merge the include system for c, c+, d, gas and nasm
* allow top == out (no build directory)
* merge the Tool/wscript system (detect->configure, set_options->options)
* rename apply_core -> process_source
* rename apply_rule -> process_rule
* rename Task.TaskBase.classes -> Task.classes
* the modules Utils.py and Logs.py are now independent from the rest of waf (imports)
* remove Task.TaskManager and Build.BuildContext.all_task_gen to improve the build group handling
* remove program_USELIB, shlib_USELIB staticlib_USELIB support
* use tasks for target installation
* improve the exception handling (WscriptError was removed, use WafError)

* let the commands access node objects
* infer the build directory from the lock filename
* post task generators in a lazy manner


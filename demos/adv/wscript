#! /usr/bin/env python
# encoding: utf-8
# Thomas Nagy, 2006 (ita)

# advanced tests
# look in src/ for an example of a new compiler that creates cpp files

# the following two variables are used by the target "waf dist"
VERSION='0.0.1'
APPNAME='adv_test'

# these variables are mandatory ('/' are converted automatically)
srcdir = '.'
blddir = '_build_'

# make sure waf has the version we want
import Utils
Utils.waf_version(mini="0.8.8", maxi="9.9.9")


def build(bld):
	# process subfolders from here
	bld.set_variants(['default', 'variant2'])
	bld.add_subdirs('src complex variant')

	# compile the flex+bison test if available
	if bld.env_of_name('default')['FLEX']:
		bld.add_subdirs('bisonflex')

def package(bld):
	pass

def configure(conf):
	# the 'checks' tool adds new method to the conf object like 'checkEndian' below
	conf.checkTool(['checks', 'gcc', 'g++', 'dang', 'flex', 'bison'])



	"""
	# pkg-config example - look in src/wscript_build, obj.uselib ..
	conf.checkPkg('glib-2.0', destvar='GLIB', vnum='2.6.0')

	conf.check_header('GL/gl.h', '', '', ['/usr/X11R6/include','/usr/include'])
	"""

	conf.addDefine('HAVE_SOMETHING', 1)

	#conf.checkEndian()
	conf.checkFeatures()
	
	conf.addDefine('TEST_DEFINE', 345)

	# command-line defines
	conf.env['CXXDEFINES_DEFTEST'] = ['truc=blah', 'boo']

	conf.env['LIB_CALC']='fl'

	# a more complicated check, anything can be put in the following code:
	code = """
#include <stdio.h>
int main()
{
        printf("ahoy");
        return 0;
}"""
	ret = conf.try_build_and_exec(code) # the method conf.try_build( works too

	conf.checkMessage('ahoj', '', 'ahoy'==ret) # boolean needed
	conf.addDefine('AHOJ', ret)

	#conf.find_program_impl('cat', ['/usr/bin', '/bin'])
	pc = conf.create_program_enumerator()
	pc.name  = 'cat'
	pc.paths = ['/usr/bin', '/bin']
	pc.run()


	conf.check_header('stdio.h')
	conf.check_header('stdarg.h', 'HAVE_STDARG_H')
	conf.check_header('dlfcn.h', 'HAVE_DLFCN_H')
	conf.check_function('printf("a")', define_name="PRINTF_FUN", headers_code='#include <stdio.h>')

	#conf.find_library('X11', ['/usr/lib','/usr/X11R6/lib'], define_name='X11_DIR')

	le = conf.create_library_enumerator()
	le.names = 'X11'
	le.paths = ['/usr/lib','/usr/X11R6/lib']
	#le.define = 'X11_DIR'
	le.run()


	conf.find_header('klocale.h', ['/usr/local/include', '/usr/include', '/opt/kde3/include/'], define_name='KDE_DIR')

	conf.detect_library('XCURSOR', 'Xcursor', ['/usr/lib','/usr/X11R6/lib'])

	conf.check_flags('Wno-pointer-sign') # typo intended

	# finally, write the configuration header
	conf.writeConfigHeader('config.h')


	headerconf=conf.create_header_configurator()

	# This demonstrates that after testing the specified paths, the compiler is given a chance
	# to see if it can find the header by itself
	
	headerconf.uselib_name='STDL'
	headerconf.names=['stdlib.h']
	headerconf.paths=['/zapp/brannigan']
	headerconf.run()

	# Finds GL/gl.h

	headerconf.uselib_name='GL'
	headerconf.names=['GL/gl.h']
	headerconf.paths=['/usr/X11R6/include','/usr/include']
	headerconf.run()





	# First column: name of the function
	# Second column (optional): defines to be set in the config.h autogenerated header

	glxprocs=[
		['glXGetProcAddressARB','HAVE_GLX_GLXGETPROCADDRESS_ARB'],
		['glXGetProcAddress','HAVE_GLX_GLXGETPROCADDRESS'],
	]

	functionfind = conf.create_function_enumerator()

	# Tries to find one of the specified functions
	
	functionfind.function_calls = glxprocs
	functionfind.headers = ['GL/glx.h']
	functionfind.include_paths = ['/usr/X11R6/include','/usr/include']
	functionfind.libs = ['GL']
	functionfind.run()





	pkgconf = conf.create_pkgconfig_configurator()

	# Looks for pkg-config package "blah5000" (should fail unless you really have such a package)
	pkgconf.uselib_name = 'BLAH5000'
	pkgconf.name = 'blah5000'
	pkgconf.run()

	# Looks for pkg-config packages "gtkmm-2.4" and sets the uselib variables with name "GTKMM"
	pkgconf.uselib_name = 'GTKMM'
	pkgconf.name = 'gtkmm-2.4'
	pkgconf.run()





	toolconf = conf.create_cfgtool_configurator()

	# Tries to use the "unobtainium-config" tool
	toolconf.uselib_name = 'UNOBTAINIUM'
	toolconf.binary = 'unobtainium-config'
	toolconf.run()

	# Tries to use the "wx-config" tool and passes the resulting libs, cppflags etc. to the WX uselib
	# variables
	toolconf.uselib_name = 'WX'
	toolconf.binary = 'wx-config'
	toolconf.run()




	libconf = conf.create_library_configurator()

	# Looks for the GL lib in the specified directories
	libconf.uselib_name = 'GL'
	libconf.names = ['GL']
	libconf.paths = ['/usr/X11R6/lib','/usr/lib','/usr/local/lib']
	libconf.run()	

	# Looks for one of the specified libs in the directories
	# The first match will be used
	libconf.uselib_name = 'WX_GL'
	libconf.names = ['wx_gtk_gl','wx_gtk2_gl','wx_gtk2u_gl','wx_gtk_gl-2.6','wx_gtk2_gl-2.6','wx_gtk2u_gl-2.6']
	libconf.paths = ['/usr/lib']
	libconf.run()	


	# set a variant called "variant2", with another config.h
	env_variant2 = conf.env.copy()
	env_variant2.set_variant('variant2')
	conf.set_env_name('variant2', env_variant2)

	conf.writeConfigHeader('config.h', env=env_variant2)

def set_options(opt):
	opt.add_option('--someopt', type='string', help='some option', dest='someopt')
	# to use after the command-line is parsed:
	# import Params
	# print Params.g_options.someopt

